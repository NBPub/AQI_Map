<!doctype html>
<html lang="en">
  <head>
    
	<!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	
	<!-- Page title, favicon -->
	<title>CO AQI Map</title>
	<link rel="icon" type="image/png" href="static/favicon.png"/>
	
	<!-- Required for Leaflet -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin="">
	</script>
	
	<!-- Page styling and Leaflet mouse coordinates plugin -->
	<style>
	  body { background-color: black; }
	  h1,h2,p { color: khaki; margin-left:10px; margin-right:10px;}
	  a { color: paleturquoise; }
	  ul {color: khaki; }
	  li { margin-bottom:5px; }
	  hr { border-color: grey; }
	  #map { height: 70vh; }
	  .leaflet-container .leaflet-control-mouseposition {
  background-color: white;
  box-shadow: 0 0 5px #bbb;
  padding: 0 5px;
  margin:0;
  color: #333;
  font: 11px/1.5 "Helvetica Neue", Arial, Helvetica, sans-serif;
}
	</style>
  </head>
  <body>
  
	<!-- Page elements -->
	<h1>
	  PM2.5 AQI Map
	  <img src="static/favicon.png" style="height:30px; width:auto; margin-left:100px;"/>
	  <div style="float:right;color:springgreen;">
	    {{ short_time_text }}
		<a href="https://github.com/NBPub/AQI_Map" target="_blank">
		  <img src="https://www.svgrepo.com/show/449764/github.svg" style="height:30px; width:auto; margin-left:50px;"/>
		</a>
	  </div>
	</h1>
    
	<div id="map"></div>
	<div>
	  <p style="font-size:1.3em;"> 
	    {{ total_sensors }} outdoor sensors returned data in the selected region, of which {{ used_sensors }} were 
		used for coloring after filtering for confidence in PM2.5 measurement and location rating.
		Click on map markers for specific sensor data.
	  </p>
	  <p style="color:springgreen;">Data retrieved on {{ time_text }}</p>
	  </div><hr><div>
	  <ul>
	    <li><a href="https://api.purpleair.com/"> Purple Air API</a> used to retrieve sensor data, see circle markers on map.</li>
	    <li>Mapping and tiles provided by <a href="https://leafletjs.com/" target="_blank">Leaflet</a> and <a href="https://www.openstreetmap.org/" target="_blank">OpenStreetMap</a></li>
	    <li>Map AQI and colors estimated by <a href="https://en.wikipedia.org/wiki/Kriging" target="_blank">Ordinary Kriging</a> with sensor data</li>
		  <ul>
		    <li>
			  AQI values over 300 color changed from <span style="background-color:maroon;">&nbsp;maroon&nbsp;</span> 
			  to <span style="background-color:darkmagenta;">&nbsp;darkmagenta&nbsp;</span>
			</li>
			<li>Sensor markers colored per table below</li>
		  </ul>
		<li>{{ geo_bbox[0] }} to {{ geo_bbox[1] }} | {{ geo_bbox[2] }} to {{ geo_bbox[3] }} were used for longitude | latitude coordinate bounds</li>
	  </ul>
	</div><hr><div>
	  <p>
	    The following table was used to calculate AQI from PM2.5 concentrations; 30 minute concentration averages were used.
		All concentrations greater than 325.4 Âµg/m<sup>3</sup> are reported to have an AQI of 501.
	  </p>
	  <a href="https://forum.airnowtech.org/t/the-aqi-equation-2024-valid-beginning-may-6th-2024/453", alt="AQI calculation table" target="_blank">
	    <img src="static/aqi_table.png">
	  </a>
	  <br>
	  <a href="https://www.airnow.gov/aqi/aqi-basics/" target="_blank">EPA AQI Basics</a>
	</div><hr><div>
	  <p>
	    Ordinary Kriging calculated using the "{{ kriging_variogram }}" variogram model with <a href="https://pykrige.readthedocs.io">PyKridge</a>.
		The <a href="data/kriging_variance.png" target="_blank">variance plot</a> approximates uncertainty in the map's AQI shading.
	  </p>
	    <img />
	
	<!-- Map Parameters -->
	<script src="static/L.Control.MousePosition.js" type="text/javascript"></script>
	<script>
	  <!-- start location, zoom, tiles -->
	  var map = L.map('map').setView([{{ (geo_bbox[2]+geo_bbox[3])/2 }}, {{ (geo_bbox[0]+geo_bbox[1])/2 }}], 10);  
		L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
		maxZoom: 19,
		attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
}).addTo(map);
		L.control.scale().addTo(map);
	  
	  <!-- Image overlay (AQI Ordinary Kriging) -->
	  var imageUrl = 'data/kriging.png';
	  var altText = 'predicted AQI from Purple Air sensor PM2.5 measurements'
	  var latLngBounds = L.latLngBounds(
		[[{{ geo_bbox[2]-0.01 }}, {{ geo_bbox[0]-0.01 }}], [{{ geo_bbox[3]+0.01 }}, {{ geo_bbox[1]+0.01 }}]]
);
	  var imageOverlay = L.imageOverlay(imageUrl, latLngBounds, {
		opacity: 0.8,
		alt: altText,
		interactive: true,
}).addTo(map);

	  <!-- Colorbar legend -->
	  var cbar = L.control({position: 'bottomright'}); 
	    cbar.onAdd = function (map) {        
		var div = L.DomUtil.create('div', 'info cbar');
		div.innerHTML = '<img src="static/colorbar.png" style="opacity:0.7";>';     
		return div;
};      
cbar.addTo(map);

	  <!-- Coordinate display -->
	  L.control.mousePosition({
	    position:"topright", separator:", ", emptyString:" ",
		numDigits:3,
}).addTo(map);

	  <!-- Add sensor information -->
	  {% for circle in circles %}
	    {{ circle|safe }}
	  {% endfor %}
	  
	</script>
  </body>
</html>